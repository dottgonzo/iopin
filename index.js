"use strict";
var child_process = require('child_process');
var Promise = require('bluebird');
var exec = child_process.exec;
var Relaypin = (function () {
    function Relaypin(confpin) {
        this.tags = [];
        if (!confpin.pin || (confpin.cmdopen && confpin.cmdclose)) {
            throw Error("no pin number provided");
        }
        else {
            var that_1 = this;
            if (confpin.pin)
                that_1.pin = confpin.pin;
            if (confpin.name)
                that_1.name = confpin.name;
            if (confpin.serial) {
                that_1.serial = confpin.serial;
            }
            else {
                that_1.serial = false;
            }
            if (confpin.status) {
                that_1.status = confpin.status;
            }
            else {
                that_1.status = that_1.normally;
            }
            if (confpin.normally) {
                that_1.normally = confpin.normally;
            }
            else {
                that_1.normally = "open";
            }
            if (confpin.tags) {
                for (var i = 0; i < confpin.tags.length; i++) {
                    that_1.tags.push(confpin.tags[i]);
                }
            }
            if (confpin.cmdopen) {
                that_1.cmdopen = confpin.cmdopen;
            }
            else {
                that_1.cmdopen = function () {
                    return new Promise(function (resolve, reject) {
                        exec('echo 1 > /sys/class/gpio/gpio' + that_1.pin + '/value', function (err, stout, stderr) {
                            if (err) {
                                reject(err);
                            }
                            else {
                                that_1.status = 'open';
                                var a = {
                                    status: that_1.status
                                };
                                if (that_1.serial)
                                    a.serial = that_1.serial;
                                if (that_1.name)
                                    a.name = that_1.name;
                                resolve(a);
                            }
                        });
                    });
                };
            }
            if (confpin.cmdclose) {
                that_1.cmdclose = confpin.cmdclose;
            }
            else {
                that_1.cmdclose = function () {
                    return new Promise(function (resolve, reject) {
                        exec('echo 0 > /sys/class/gpio/gpio' + that_1.pin + '/value', function (err, stout, stderr) {
                            if (err) {
                                reject(err);
                            }
                            else {
                                that_1.status = 'close';
                                var a = {
                                    status: that_1.status
                                };
                                if (that_1.serial)
                                    a.serial = that_1.serial;
                                if (that_1.name)
                                    a.name = that_1.name;
                                resolve(a);
                            }
                        });
                    });
                };
            }
        }
    }
    Relaypin.prototype.switch = function () {
        var that = this;
        return new Promise(function (resolve, reject) {
            if (that.status) {
                that.switchclose().then(function (a) {
                    for (var i = 0; i < that.onswitch.length; i++) {
                        that.onswitch[i];
                    }
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            }
            else {
                that.switchopen().then(function (a) {
                    for (var i = 0; i < that.onswitch.length; i++) {
                        that.onswitch[i];
                    }
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            }
        });
    };
    Relaypin.prototype.switchopen = function () {
        var that = this;
        return new Promise(function (resolve, reject) {
            if (that.status === 'close') {
                that.cmdopen().then(function (a) {
                    for (var i = 0; i < that.onopen.length; i++) {
                        that.onopen[i];
                    }
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            }
        });
    };
    Relaypin.prototype.switchclose = function () {
        var that = this;
        return new Promise(function (resolve, reject) {
            if (that.status === 'close') {
                that.cmdclose().then(function (a) {
                    for (var i = 0; i < that.onclose.length; i++) {
                        that.onclose[i];
                    }
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            }
        });
    };
    Relaypin.prototype.on = function (value, cmd) {
        if (cmd) {
            if (value === 'close') {
                this.onclose.push(cmd);
            }
            else if (value === 'open') {
                this.onopen.push(cmd);
            }
            else if (value === 'switch') {
                this.onswitch.push(cmd);
            }
            else {
                throw Error("no pin number provided");
            }
        }
        else {
            throw Error("no pin number provided");
        }
    };
    return Relaypin;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = Relaypin;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUMsSUFBSSxDQUFDLENBQUM7Z0JBQ0osTUFBTSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQTtZQUN6QyxDQUFDO1FBRUwsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osTUFBTSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQTtRQUN6QyxDQUFDO0lBQ0wsQ0FBQztJQUNMLGVBQUM7QUFBRCxDQS9KQSxBQStKQyxJQUFBO0FBL0pEOzBCQStKQyxDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG50eXBlIFRzd2l0Y2hBbGwgPSBcIm9wZW5cIiB8IFwiY2xvc2VcIiB8IFwic3dpdGNoXCI7XG50eXBlIFRzd2l0YyA9IFwib3BlblwiIHwgXCJjbG9zZVwiO1xuXG5pbnRlcmZhY2UgSVJlbGF5cGluIHtcbiAgICBub3JtYWxseT86IFRzd2l0YztcbiAgICBwaW46IG51bWJlcjtcbiAgICBuYW1lPzogc3RyaW5nO1xuICAgIHRhZ3M/OiBzdHJpbmdbXTtcbiAgICBzdGF0dXM/OiBUc3dpdGM7XG4gICAgY21kb3Blbj86ICgpID0+IFByb21pc2U8SVN3aXRjaEFuc3dlcj47XG4gICAgY21kY2xvc2U/OiAoKSA9PiBQcm9taXNlPElTd2l0Y2hBbnN3ZXI+O1xuICAgIHNlcmlhbD86IGZhbHNlIHwgc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSVN3aXRjaEFuc3dlciB7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICBzZXJpYWw/OiBzdHJpbmc7XG4gICAgc3RhdHVzOiBzdHJpbmc7XG59XG5cbmltcG9ydCAqIGFzIGNoaWxkX3Byb2Nlc3MgZnJvbSAnY2hpbGRfcHJvY2VzcydcblxuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcbmNvbnN0IGV4ZWMgPSBjaGlsZF9wcm9jZXNzLmV4ZWNcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVsYXlwaW4gaW1wbGVtZW50cyBJUmVsYXlwaW4ge1xuICAgIG5vcm1hbGx5OiBUc3dpdGM7XG4gICAgcGluOiBudW1iZXI7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICB0YWdzOiBzdHJpbmdbXSA9IFtdO1xuICAgIHN0YXR1czogVHN3aXRjO1xuICAgIGNtZG9wZW46ICgpID0+IFByb21pc2U8SVN3aXRjaEFuc3dlcj47XG4gICAgY21kY2xvc2U6ICgpID0+IFByb21pc2U8SVN3aXRjaEFuc3dlcj47XG4gICAgb25zd2l0Y2g6IEZ1bmN0aW9uW107XG4gICAgb25vcGVuOiBGdW5jdGlvbltdO1xuICAgIG9uY2xvc2U6IEZ1bmN0aW9uW107XG4gICAgc2VyaWFsOiBmYWxzZSB8IHN0cmluZztcbiAgICBjb25zdHJ1Y3Rvcihjb25mcGluOiBJUmVsYXlwaW4pIHtcblxuICAgICAgICBpZiAoIWNvbmZwaW4ucGluIHx8IChjb25mcGluLmNtZG9wZW4gJiYgY29uZnBpbi5jbWRjbG9zZSkpIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKFwibm8gcGluIG51bWJlciBwcm92aWRlZFwiKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgdGhhdCA9IHRoaXNcbiAgICAgICAgICAgIGlmIChjb25mcGluLnBpbikgdGhhdC5waW4gPSBjb25mcGluLnBpblxuICAgICAgICAgICAgaWYgKGNvbmZwaW4ubmFtZSkgdGhhdC5uYW1lID0gY29uZnBpbi5uYW1lXG4gICAgICAgICAgICBpZiAoY29uZnBpbi5zZXJpYWwpIHtcbiAgICAgICAgICAgICAgICB0aGF0LnNlcmlhbCA9IGNvbmZwaW4uc2VyaWFsXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoYXQuc2VyaWFsID0gZmFsc2VcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb25mcGluLnN0YXR1cykge1xuICAgICAgICAgICAgICAgIHRoYXQuc3RhdHVzID0gY29uZnBpbi5zdGF0dXNcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhhdC5zdGF0dXMgPSB0aGF0Lm5vcm1hbGx5XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY29uZnBpbi5ub3JtYWxseSkge1xuICAgICAgICAgICAgICAgIHRoYXQubm9ybWFsbHkgPSBjb25mcGluLm5vcm1hbGx5XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoYXQubm9ybWFsbHkgPSBcIm9wZW5cIiAvLyBkZWZhdWx0IG5vcm1hbGx5XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb25mcGluLnRhZ3MpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvbmZwaW4udGFncy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICB0aGF0LnRhZ3MucHVzaChjb25mcGluLnRhZ3NbaV0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNvbmZwaW4uY21kb3Blbikge1xuICAgICAgICAgICAgICAgIHRoYXQuY21kb3BlbiA9IGNvbmZwaW4uY21kb3BlblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGF0LmNtZG9wZW4gPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJU3dpdGNoQW5zd2VyPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGVjKCdlY2hvIDEgPiAvc3lzL2NsYXNzL2dwaW8vZ3BpbycgKyB0aGF0LnBpbiArICcvdmFsdWUnLCBmdW5jdGlvbiAoZXJyLCBzdG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuc3RhdHVzID0gJ29wZW4nXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGE6IElTd2l0Y2hBbnN3ZXIgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHRoYXQuc3RhdHVzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQuc2VyaWFsKSBhLnNlcmlhbCA9IHRoYXQuc2VyaWFsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGF0Lm5hbWUpIGEubmFtZSA9IHRoYXQubmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGEpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY29uZnBpbi5jbWRjbG9zZSkge1xuICAgICAgICAgICAgICAgIHRoYXQuY21kY2xvc2UgPSBjb25mcGluLmNtZGNsb3NlXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoYXQuY21kY2xvc2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJU3dpdGNoQW5zd2VyPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBleGVjKCdlY2hvIDAgPiAvc3lzL2NsYXNzL2dwaW8vZ3BpbycgKyB0aGF0LnBpbiArICcvdmFsdWUnLCBmdW5jdGlvbiAoZXJyLCBzdG91dCwgc3RkZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQuc3RhdHVzID0gJ2Nsb3NlJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhOiBJU3dpdGNoQW5zd2VyID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiB0aGF0LnN0YXR1c1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGF0LnNlcmlhbCkgYS5zZXJpYWwgPSB0aGF0LnNlcmlhbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5uYW1lKSBhLm5hbWUgPSB0aGF0Lm5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG5cbiAgICBzd2l0Y2goKSB7XG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJU3dpdGNoQW5zd2VyPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICBpZiAodGhhdC5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICB0aGF0LnN3aXRjaGNsb3NlKCkudGhlbihmdW5jdGlvbiAoYSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoYXQub25zd2l0Y2gubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQub25zd2l0Y2hbaV1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGEpXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoYXQuc3dpdGNob3BlbigpLnRoZW4oZnVuY3Rpb24gKGEpIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGF0Lm9uc3dpdGNoLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0Lm9uc3dpdGNoW2ldXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhKVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH1cbiAgICBzd2l0Y2hvcGVuKCkge1xuICAgICAgICBjb25zdCB0aGF0ID0gdGhpc1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8SVN3aXRjaEFuc3dlcj4oZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgaWYgKHRoYXQuc3RhdHVzID09PSAnY2xvc2UnKSB7XG4gICAgICAgICAgICAgICAgdGhhdC5jbWRvcGVuKCkudGhlbihmdW5jdGlvbiAoYSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoYXQub25vcGVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGF0Lm9ub3BlbltpXVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYSlcbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9XG4gICAgc3dpdGNoY2xvc2UoKSB7XG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJU3dpdGNoQW5zd2VyPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICBpZiAodGhhdC5zdGF0dXMgPT09ICdjbG9zZScpIHtcbiAgICAgICAgICAgICAgICB0aGF0LmNtZGNsb3NlKCkudGhlbihmdW5jdGlvbiAoYSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoYXQub25jbG9zZS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5vbmNsb3NlW2ldXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhKVxuICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICB9KVxuICAgIH1cbiAgICBvbih2YWx1ZTogVHN3aXRjaEFsbCwgY21kOiBGdW5jdGlvbikge1xuICAgICAgICBpZiAoY21kKSB7XG4gICAgICAgICAgICBpZiAodmFsdWUgPT09ICdjbG9zZScpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uY2xvc2UucHVzaChjbWQpXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSAnb3BlbicpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9ub3Blbi5wdXNoKGNtZClcblxuICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gJ3N3aXRjaCcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm9uc3dpdGNoLnB1c2goY21kKVxuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IEVycm9yKFwibm8gcGluIG51bWJlciBwcm92aWRlZFwiKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBFcnJvcihcIm5vIHBpbiBudW1iZXIgcHJvdmlkZWRcIilcbiAgICAgICAgfVxuICAgIH1cbn0iXX0=
