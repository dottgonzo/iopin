"use strict";
var child_process = require('child_process');
var Promise = require('bluebird');
var exec = child_process.exec;
var Relaypin = (function () {
    function Relaypin(confpin) {
        this.tags = [];
        if (!confpin.pin) {
            throw Error("no pin number provided");
        }
        else {
            var that_1 = this;
            that_1.pin = confpin.pin;
            if (confpin.name)
                that_1.name = confpin.name;
            if (confpin.serial) {
                that_1.serial = confpin.serial;
            }
            else {
                that_1.serial = false;
            }
            if (confpin.status) {
                that_1.status = confpin.status;
            }
            else {
                that_1.status = that_1.normally;
            }
            if (confpin.normally) {
                that_1.normally = confpin.normally;
            }
            else {
                that_1.normally = "open";
            }
            if (confpin.tags) {
                for (var i = 0; i < confpin.tags.length; i++) {
                    that_1.tags.push(confpin.tags[i]);
                }
            }
            if (confpin.cmdopen) {
                that_1.cmdopen = confpin.cmdopen;
            }
            else {
                that_1.cmdopen = function () {
                    return new Promise(function (resolve, reject) {
                        exec('echo 1 > /sys/class/gpio/gpio' + that_1.pin + '/value', function (err, stout, stderr) {
                            if (err) {
                                reject(err);
                            }
                            else {
                                that_1.status = 'open';
                                var a = {
                                    status: that_1.status,
                                    pin: that_1.pin
                                };
                                if (that_1.serial)
                                    a.serial = that_1.serial;
                                if (that_1.name)
                                    a.name = that_1.name;
                                resolve(a);
                            }
                        });
                    });
                };
            }
            if (confpin.cmdclose) {
                that_1.cmdclose = confpin.cmdclose;
            }
            else {
                that_1.cmdclose = function () {
                    return new Promise(function (resolve, reject) {
                        exec('echo 0 > /sys/class/gpio/gpio' + that_1.pin + '/value', function (err, stout, stderr) {
                            if (err) {
                                reject(err);
                            }
                            else {
                                that_1.status = 'close';
                                var a = {
                                    status: that_1.status,
                                    pin: that_1.pin
                                };
                                if (that_1.serial)
                                    a.serial = that_1.serial;
                                if (that_1.name)
                                    a.name = that_1.name;
                                resolve(a);
                            }
                        });
                    });
                };
            }
        }
    }
    Relaypin.prototype.switch = function () {
        var that = this;
        return new Promise(function (resolve, reject) {
            if (that.status) {
                that.switchclose().then(function (a) {
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            }
            else {
                that.switchopen().then(function (a) {
                    resolve(a);
                }).catch(function (err) {
                    reject(err);
                });
            }
        });
    };
    Relaypin.prototype.switchopen = function () {
        var that = this;
        return new Promise(function (resolve, reject) {
            if (that.status === 'close') {
                that.cmdopen().then(function (a) {
                    for (var i = 0; i < that.onopen.length; i++) {
                        that.onopen[i];
                        resolve(a);
                    }
                }).catch(function (err) {
                    reject(err);
                });
            }
        });
    };
    Relaypin.prototype.switchclose = function () {
        var that = this;
        return new Promise(function (resolve, reject) {
            if (that.status === 'close') {
                that.cmdclose().then(function (a) {
                    for (var i = 0; i < that.onclose.length; i++) {
                        that.onclose[i];
                        resolve(a);
                    }
                }).catch(function (err) {
                    reject(err);
                });
            }
        });
    };
    Relaypin.prototype.on = function (value, cmd) {
        if (cmd) {
            if (value === 'close') {
                this.onclose.push(cmd);
            }
            else if (value === 'open') {
                this.onopen.push(cmd);
            }
            else if (value === 'switch') {
                this.switches.push(cmd);
            }
            else {
                throw Error("no pin number provided");
            }
        }
        else {
            throw Error("no pin number provided");
        }
    };
    return Relaypin;
}());
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = Relaypin;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUssQ0FBQyxVQUFVLEdBQUc7b0JBQ2xCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDZixDQUFDLENBQUMsQ0FBQTtZQUNOLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUM7SUFDRCxxQkFBRSxHQUFGLFVBQUcsS0FBaUIsRUFBRSxHQUFhO1FBQy9CLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDTixFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFDcEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDMUIsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQztnQkFDMUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7WUFFekIsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDNUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7WUFFM0IsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNKLE1BQU0sS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUE7WUFDekMsQ0FBQztRQUVMLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLE1BQU0sS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUE7UUFDekMsQ0FBQztJQUNMLENBQUM7SUFDTCxlQUFDO0FBQUQsQ0E1SkEsQUE0SkMsSUFBQTtBQTVKRDswQkE0SkMsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxudHlwZSBUc3dpdGNoQWxsID0gXCJvcGVuXCIgfCBcImNsb3NlXCIgfCBcInN3aXRjaFwiO1xudHlwZSBUc3dpdGMgPSBcIm9wZW5cIiB8IFwiY2xvc2VcIjtcblxuaW50ZXJmYWNlIElSZWxheXBpbiB7XG4gICAgbm9ybWFsbHk/OiBUc3dpdGM7XG4gICAgcGluOiBudW1iZXI7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICB0YWdzPzogc3RyaW5nW107XG4gICAgc3RhdHVzPzogVHN3aXRjXG4gICAgY21kb3Blbj86ICgpID0+IFByb21pc2U8SVN3aXRjaEFuc3dlcj47XG4gICAgY21kY2xvc2U/OiAoKSA9PiBQcm9taXNlPElTd2l0Y2hBbnN3ZXI+O1xuICAgIHNlcmlhbD86IGZhbHNlIHwgc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgSVN3aXRjaEFuc3dlciB7XG4gICAgcGluOiBudW1iZXI7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICBzZXJpYWw/OiBzdHJpbmc7XG4gICAgc3RhdHVzOiBzdHJpbmc7XG59XG5cbmltcG9ydCAqIGFzIGNoaWxkX3Byb2Nlc3MgZnJvbSAnY2hpbGRfcHJvY2VzcydcblxuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tICdibHVlYmlyZCdcblxuXG5jb25zdCBleGVjID0gY2hpbGRfcHJvY2Vzcy5leGVjXG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlbGF5cGluIGltcGxlbWVudHMgSVJlbGF5cGluIHtcbiAgICBub3JtYWxseTogVHN3aXRjXG4gICAgcGluOiBudW1iZXJcbiAgICBuYW1lPzogc3RyaW5nO1xuICAgIHRhZ3M6IHN0cmluZ1tdID0gW107XG4gICAgc3RhdHVzOiBUc3dpdGM7XG4gICAgY21kb3BlbjogKCkgPT4gUHJvbWlzZTxJU3dpdGNoQW5zd2VyPjtcbiAgICBjbWRjbG9zZTogKCkgPT4gUHJvbWlzZTxJU3dpdGNoQW5zd2VyPjtcbiAgICBzd2l0Y2hlczogRnVuY3Rpb25bXTtcbiAgICBvbm9wZW46IEZ1bmN0aW9uW107XG4gICAgb25jbG9zZTogRnVuY3Rpb25bXTtcbiAgICBzZXJpYWw6IGZhbHNlIHwgc3RyaW5nO1xuICAgIGNvbnN0cnVjdG9yKGNvbmZwaW46IElSZWxheXBpbikge1xuXG4gICAgICAgIGlmICghY29uZnBpbi5waW4pIHtcbiAgICAgICAgICAgIHRocm93IEVycm9yKFwibm8gcGluIG51bWJlciBwcm92aWRlZFwiKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgdGhhdCA9IHRoaXNcbiAgICAgICAgICAgIHRoYXQucGluID0gY29uZnBpbi5waW5cbiAgICAgICAgICAgIGlmIChjb25mcGluLm5hbWUpIHRoYXQubmFtZSA9IGNvbmZwaW4ubmFtZVxuICAgICAgICAgICAgaWYgKGNvbmZwaW4uc2VyaWFsKSB7XG4gICAgICAgICAgICAgICAgdGhhdC5zZXJpYWwgPSBjb25mcGluLnNlcmlhbFxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGF0LnNlcmlhbCA9IGZhbHNlXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoY29uZnBpbi5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICB0aGF0LnN0YXR1cyA9IGNvbmZwaW4uc3RhdHVzXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoYXQuc3RhdHVzID0gdGhhdC5ub3JtYWxseVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNvbmZwaW4ubm9ybWFsbHkpIHtcbiAgICAgICAgICAgICAgICB0aGF0Lm5vcm1hbGx5ID0gY29uZnBpbi5ub3JtYWxseVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGF0Lm5vcm1hbGx5ID0gXCJvcGVuXCIgLy8gZGVmYXVsdCBub3JtYWxseVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29uZnBpbi50YWdzKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb25mcGluLnRhZ3MubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgdGhhdC50YWdzLnB1c2goY29uZnBpbi50YWdzW2ldKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb25mcGluLmNtZG9wZW4pIHtcbiAgICAgICAgICAgICAgICB0aGF0LmNtZG9wZW4gPSBjb25mcGluLmNtZG9wZW5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhhdC5jbWRvcGVuID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8SVN3aXRjaEFuc3dlcj4oZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXhlYygnZWNobyAxID4gL3N5cy9jbGFzcy9ncGlvL2dwaW8nICsgdGhhdC5waW4gKyAnL3ZhbHVlJywgZnVuY3Rpb24gKGVyciwgc3RvdXQsIHN0ZGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0LnN0YXR1cyA9ICdvcGVuJ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhOiBJU3dpdGNoQW5zd2VyID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiB0aGF0LnN0YXR1cyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpbjogdGhhdC5waW5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5zZXJpYWwpIGEuc2VyaWFsID0gdGhhdC5zZXJpYWxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoYXQubmFtZSkgYS5uYW1lID0gdGhhdC5uYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjb25mcGluLmNtZGNsb3NlKSB7XG4gICAgICAgICAgICAgICAgdGhhdC5jbWRjbG9zZSA9IGNvbmZwaW4uY21kY2xvc2VcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhhdC5jbWRjbG9zZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPElTd2l0Y2hBbnN3ZXI+KGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGV4ZWMoJ2VjaG8gMCA+IC9zeXMvY2xhc3MvZ3Bpby9ncGlvJyArIHRoYXQucGluICsgJy92YWx1ZScsIGZ1bmN0aW9uIChlcnIsIHN0b3V0LCBzdGRlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5zdGF0dXMgPSAnY2xvc2UnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGE6IElTd2l0Y2hBbnN3ZXIgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHRoYXQuc3RhdHVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGluOiB0aGF0LnBpblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGF0LnNlcmlhbCkgYS5zZXJpYWwgPSB0aGF0LnNlcmlhbFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhhdC5uYW1lKSBhLm5hbWUgPSB0aGF0Lm5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShhKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIHN3aXRjaCgpIHtcbiAgICAgICAgY29uc3QgdGhhdCA9IHRoaXNcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPElTd2l0Y2hBbnN3ZXI+KGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgIGlmICh0aGF0LnN0YXR1cykge1xuICAgICAgICAgICAgICAgIHRoYXQuc3dpdGNoY2xvc2UoKS50aGVuKGZ1bmN0aW9uIChhKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYSlcbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhhdC5zd2l0Y2hvcGVuKCkudGhlbihmdW5jdGlvbiAoYSkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGEpXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgfVxuICAgIHN3aXRjaG9wZW4oKSB7XG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJU3dpdGNoQW5zd2VyPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICBpZiAodGhhdC5zdGF0dXMgPT09ICdjbG9zZScpIHtcbiAgICAgICAgICAgICAgICB0aGF0LmNtZG9wZW4oKS50aGVuKGZ1bmN0aW9uIChhKSB7XG4gICAgICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhhdC5vbm9wZW4ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQub25vcGVuW2ldXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGEpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9XG4gICAgc3dpdGNoY2xvc2UoKSB7XG4gICAgICAgIGNvbnN0IHRoYXQgPSB0aGlzXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJU3dpdGNoQW5zd2VyPihmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICBpZiAodGhhdC5zdGF0dXMgPT09ICdjbG9zZScpIHtcbiAgICAgICAgICAgICAgICB0aGF0LmNtZGNsb3NlKCkudGhlbihmdW5jdGlvbiAoYSkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoYXQub25jbG9zZS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5vbmNsb3NlW2ldXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGEpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICB9XG4gICAgb24odmFsdWU6IFRzd2l0Y2hBbGwsIGNtZDogRnVuY3Rpb24pIHtcbiAgICAgICAgaWYgKGNtZCkge1xuICAgICAgICAgICAgaWYgKHZhbHVlID09PSAnY2xvc2UnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbmNsb3NlLnB1c2goY21kKVxuICAgICAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gJ29wZW4nKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5vbm9wZW4ucHVzaChjbWQpXG5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09ICdzd2l0Y2gnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zd2l0Y2hlcy5wdXNoKGNtZClcblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihcIm5vIHBpbiBudW1iZXIgcHJvdmlkZWRcIilcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgRXJyb3IoXCJubyBwaW4gbnVtYmVyIHByb3ZpZGVkXCIpXG4gICAgICAgIH1cbiAgICB9XG59Il19
